<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF--8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Office Attendance Portal</title>
    
    <style>
        :root {
            --primary-color: #3498db; --dark-blue: #2c3e50; --light-gray: #f4f7f9;
            --medium-gray: #ecf0f1; --text-color: #333; --white: #ffffff;
            --danger-color: #e74c3c; --success-color: #27ae60;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--light-gray); margin: 0; color: var(--text-color); }
        .App { text-align: center; }
        .app-header { background-color: var(--dark-blue); padding: 15px 20px; color: var(--white); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .app-header h1 { margin: 0; font-size: 1.5em; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .header-button { background-color: var(--primary-color); color: var(--white); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .signout-button { background-color: var(--danger-color); }
        .auth-container { display: flex; justify-content: center; align-items: center; margin: 40px 20px; }
        .auth-form { background: var(--white); padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .auth-button { width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .toggle-button { background: none; border: none; color: var(--primary-color); cursor: pointer; margin-top: 20px; padding: 0; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .dashboard-layout { display: flex; max-width: 1200px; margin: 20px auto; background: var(--white); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; min-height: 80vh; }
        .dashboard-nav { flex: 0 0 220px; background-color: var(--medium-gray); border-right: 1px solid #ddd; padding: 20px 0; border-radius: 8px 0 0 8px; }
        .dashboard-nav-button { display: block; width: 100%; padding: 15px 20px; background: none; border: none; text-align: left; font-size: 1em; color: var(--dark-blue); cursor: pointer; border-left: 4px solid transparent; }
        .dashboard-nav-button.active { background-color: var(--white); border-left: 4px solid var(--primary-color); font-weight: bold; }
        .dashboard-content { flex-grow: 1; padding: 30px; overflow: hidden; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        .data-table th { background-color: var(--medium-gray); }
        .incomplete-record { color: #e67e22; }

        @media (max-width: 768px) {
            .dashboard-layout { flex-direction: column; }
            .dashboard-nav { flex-direction: row; flex: 0 0 auto; border-right: none; border-bottom: 1px solid #ddd; padding: 0; border-radius: 8px 8px 0 0; display: flex; }
            .dashboard-nav-button { flex: 1; text-align: center; border-left: none; border-bottom: 4px solid transparent; padding: 15px 5px; font-size: 0.9em; }
            .dashboard-nav-button.active { border-bottom: 4px solid var(--primary-color); }
        }

        .qr-timer { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
        .qr-timer span { color: var(--primary-color); }
        #qrcode-container { display: flex; justify-content: center; align-items: center; padding: 20px; border: 1px solid #ddd; border-radius: 8px; min-height: 256px; }
        .scan-area { display: flex; flex-direction: column; align-items: center; }
        .qr-reader-container { width: 100%; max-width: 400px; aspect-ratio: 1 / 1; border: 3px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: #fafafa; margin-bottom: 20px; position: relative; }
        #qr-reader { width: 100%; border-radius: 6px; }
        .qr-reader-container p { position: absolute; }
        .scan-button { background-color: var(--success-color); color: var(--white); font-size: 1.1em; padding: 15px 30px; border-radius: 8px; border: none; cursor: pointer; }
        .status-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.1em; }
        .status-in { background-color: #e8f5e9; color: #2e7d32; }
        .status-out { background-color: #fff3e0; color: #e65100; }
        .message { padding: 10px; border-radius: 4px; margin: 15px 0; border: 1px solid transparent; }
        .message.success { background-color: #e8f5e9; color: #2e7d32; }
        .message.error { background-color: #fdecea; color: #c62828; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--white); padding: 30px 40px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left;}
        .modal-content h2 { color: var(--dark-blue); margin-top: 0; }
        .profile-info p { margin: 10px 0; font-size: 1.1em; }
        .profile-info strong { color: var(--dark-blue); min-width: 80px; display: inline-block; }
        .modal-close-btn { display: block; margin: 20px auto 0; padding: 10px 30px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 5px; font-size: 1em; cursor: pointer; }
    </style>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const firebaseConfig = {
          apiKey: "AIzaSyA4521rQz-6fd1Gvo52T6m1hJjuo06QguU",
          authDomain: "attendence-f7ea5.firebaseapp.com",
          projectId: "attendence-f7ea5",
          storageBucket: "attendence-f7ea5.firebasestorage.app",
          messagingSenderId: "693491114475",
          appId: "1:693491114475:web:fdf1b333c9c9938a96b9ae"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ProfileModal = ({ user, onClose }) => {
            if (!user) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2>User Profile</h2>
                        <div className="profile-info">
                            <p><strong>Name:</strong> {user.name || 'Not set'}</p>
                            <p><strong>Email:</strong> {user.email}</p>
                            <p><strong>Role:</strong> <span style={{textTransform: 'capitalize'}}>{user.role}</span></p>
                        </div>
                        <button className="modal-close-btn" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        };

        const Auth = () => {
            const [isSignUp, setIsSignUp] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('employee');
            const [name, setName] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isSignUp && !name) {
                    alert('Please enter your full name.');
                    return;
                }
                try {
                    if (isSignUp) {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        await db.collection("users").doc(userCredential.user.uid).set({ 
                            uid: userCredential.user.uid, 
                            email: userCredential.user.email, 
                            role: role,
                            name: name
                        });
                    } else { await auth.signInWithEmailAndPassword(email, password); }
                } catch (err) { alert(err.message); }
            };
            return (
                <div className="auth-container">
                    <div className="auth-form">
                        <h2>{isSignUp ? 'Create Account' : 'Sign In'}</h2>
                        <form onSubmit={handleSubmit}>
                            {isSignUp && (
                                <div className="input-group">
                                    <label>Full Name</label>
                                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} required />
                                </div>
                            )}
                            <div className="input-group"><label>Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required /></div>
                            <div className="input-group"><label>Password</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required /></div>
                            {isSignUp && (<div className="input-group"><label>Select Your Role</label><select value={role} onChange={(e) => setRole(e.target.value)}><option value="employee">Employee</option><option value="admin">Admin</option></select></div>)}
                            <button type="submit" className="auth-button">{isSignUp ? 'Sign Up' : 'Sign In'}</button>
                        </form>
                        <button onClick={() => setIsSignUp(!isSignUp)} className="toggle-button">{isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up"}</button>
                    </div>
                </div>
            );
        };
        
        const AdminDashboard = () => {
            const [users, setUsers] = useState([]);
            const [attendanceRecords, setAttendanceRecords] = useState([]);
            const [loading, setLoading] = useState({ users: true, records: true });
            const qrCodeRef = useRef(null);
            const [activeView, setActiveView] = useState('dashboard');
            const [countdown, setCountdown] = useState(30);
            const [qrPayload, setQrPayload] = useState('');

            useEffect(() => {
                let qrInterval;
                let countdownInterval;
                const generateNewToken = async () => {
                    setCountdown(30);
                    const token = Math.random().toString(36).substring(2, 15);
                    const expiry = Date.now() + 30000;
                    try {
                        await db.collection('system').doc('qr_token').set({ token, expiry });
                        setQrPayload(JSON.stringify({ token, expiry }));
                    } catch (error) {
                        console.error("Error generating QR token:", error);
                    }
                };
                
                generateNewToken();
                qrInterval = setInterval(generateNewToken, 30000);
                countdownInterval = setInterval(() => {
                    setCountdown(prev => (prev > 0 ? prev - 1 : 30));
                }, 1000);
                
                return () => {
                    clearInterval(qrInterval);
                    clearInterval(countdownInterval);
                };
            }, []);

            useEffect(() => {
                if (activeView === 'dashboard' && qrPayload) {
                    const qrContainer = document.getElementById('qrcode-container');
                    if (qrContainer) {
                        qrContainer.innerHTML = ''; // Clear previous QR code
                        qrCodeRef.current = new QRCode(qrContainer, { text: qrPayload, width: 256, height: 256 });
                    }
                }
            }, [activeView, qrPayload]);

            useEffect(() => {
                const fetchData = async () => {
                    setLoading({ users: true, records: true });
                    try {
                        const userSnapshot = await db.collection('users').get();
                        setUsers(userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        const attendanceSnapshot = await db.collection('attendance').orderBy('timestamp', 'desc').get();
                        const records = attendanceSnapshot.docs.map(doc => doc.data());
                        const groupedRecords = records.reduce((acc, record) => { const date = record.date; const email = record.email; const key = `${email}|${date}`; if (!acc[key]) { acc[key] = { email, date, punches: [] }; } acc[key].punches.push({ type: record.type, time: new Date(record.timestamp.seconds * 1000) }); return acc; }, {});
                        const processedRecords = Object.values(groupedRecords).map(group => { const ins = group.punches.filter(p => p.type === 'in').sort((a, b) => a.time - b.time); const outs = group.punches.filter(p => p.type === 'out').sort((a, b) => a.time - b.time); if (ins.length > 0 && outs.length > 0) { const firstIn = ins[0].time; const lastOut = outs[outs.length - 1].time; const diffMs = lastOut - firstIn; if (diffMs < 0) return { ...group, status: 'Incomplete' }; const hours = Math.floor(diffMs / 3600000); const minutes = Math.floor((diffMs % 3600000) / 60000); return { ...group, status: 'Completed', firstIn, lastOut, workHours: `${hours}h ${minutes}m` }; } return { ...group, status: 'Incomplete' }; });
                        setAttendanceRecords(processedRecords);
                    } catch (error) { console.error("Failed to fetch admin data:", error); }
                    finally { setLoading({ users: false, records: false }); }
                };
                fetchData();
            }, []);

            const handleRoleChange = async (userId, newRole) => { await db.collection('users').doc(userId).update({ role: newRole }); setUsers(users.map(u => u.id === userId ? { ...u, role: newRole } : u)); };
            
            return ( <div className="dashboard-layout"> <nav className="dashboard-nav"> <button className={`dashboard-nav-button ${activeView === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveView('dashboard')}>Dashboard</button> <button className={`dashboard-nav-button ${activeView === 'attendance' ? 'active' : ''}`} onClick={() => setActiveView('attendance')}>Attendance</button> <button className={`dashboard-nav-button ${activeView === 'users' ? 'active' : ''}`} onClick={() => setActiveView('users')}>Users</button> </nav> <main className="dashboard-content"> {activeView === 'dashboard' && (<div><h2>Live QR Code</h2><div className="qr-timer">New code in: <span>{countdown}s</span></div><div id="qrcode-container">{!qrPayload && <div className="loading-spinner"></div>}</div></div>)} {activeView === 'attendance' && (<div><h2>Attendance Records</h2>{loading.records ? <div className="loading-spinner"></div> : (<div className="table-responsive"><table className="data-table"><thead><tr><th>Employee</th><th>Date</th><th>Punch In</th><th>Punch Out</th><th>Working Hours</th></tr></thead><tbody>{attendanceRecords.map(rec => (<tr key={`${rec.email}-${rec.date}`}>{rec.status === 'Completed' ? (<><td>{rec.email}</td><td>{rec.date}</td><td>{rec.firstIn.toLocaleTimeString()}</td><td>{rec.lastOut.toLocaleTimeString()}</td><td><strong>{rec.workHours}</strong></td></>) : (<><td>{rec.email}</td><td>{rec.date}</td><td>{rec.punches.find(p=>p.type==='in')?.time.toLocaleTimeString() || 'N/A'}</td><td>{rec.punches.find(p=>p.type==='out')?.time.toLocaleTimeString() || 'N/A'}</td><td className="incomplete-record">{rec.status}</td></>)}</tr>))}</tbody></table></div>)}</div>)} 
            {activeView === 'users' && (<div><h2>User Management</h2>{loading.users ? <div className="loading-spinner"></div> : ( 
            users.length > 0 ? (
                <div className="table-responsive">
                <table className="data-table">
                    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Change Role</th></tr></thead>
                    <tbody>{users.map(user => (
                        <tr key={user.id}>
                            <td>{user.name}</td>
                            <td>{user.email}</td>
                            <td style={{textTransform: 'capitalize'}}>{user.role}</td>
                            <td>
                                <select 
                                    value={user.role} 
                                    onChange={(e) => handleRoleChange(user.id, e.target.value)}
                                    disabled={user.role === 'admin'}
                                >
                                    <option value="admin">Admin</option>
                                    <option value="employee">Employee</option>
                                </select>
                            </td>
                        </tr>
                    ))}</tbody>
                </table>
                </div>
            ) : (
                <p>No users found. This may be due to Firestore security rules limiting access.</p>
            )
            )}</div>)} 
            </main> </div> );
        };

        // --- APPLIED FIX IS IN THIS COMPONENT ---
        const EmployeeDashboard = () => {
            const [activeView, setActiveView] = useState('scan');
            const [lastPunch, setLastPunch] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [message, setMessage] = useState(null);
            const html5QrCodeRef = useRef(null);
            const [myRecords, setMyRecords] = useState([]);
            const [loadingRecords, setLoadingRecords] = useState(true);

            const toJsDate = (timestamp) => {
                if (!timestamp) return null;
                if (typeof timestamp.seconds === 'number' && typeof timestamp.nanoseconds === 'number') {
                    return timestamp.toDate();
                }
                return timestamp;
            };

            const fetchEmployeeData = async () => {
                if (!auth.currentUser) return;
                setLoadingRecords(true);
                try {
                    const attendanceRef = db.collection('attendance').where('userId', '==', auth.currentUser.uid).orderBy('timestamp', 'desc');
                    const snapshot = await attendanceRef.get();
                    const allRecords = snapshot.docs.map(doc => doc.data());

                    const todayStr = new Date().toISOString().split('T')[0];
                    const todaysRecords = allRecords.filter(rec => rec.date === todayStr);

                    if (todaysRecords.length > 0) {
                        setLastPunch(todaysRecords[0]);
                    } else {
                        setLastPunch({ type: 'out' });
                    }
                    
                    if (allRecords.length === 0) {
                        setMyRecords([]);
                    } else {
                        const groupedRecords = allRecords.reduce((acc, record) => { 
                            const date = record.date; 
                            if (!acc[date]) { acc[date] = { date, punches: [] }; } 
                            acc[date].punches.push({ type: record.type, time: toJsDate(record.timestamp) }); 
                            return acc; 
                        }, {});

                        const processedRecords = Object.values(groupedRecords).map(group => { 
                            const ins = group.punches.filter(p => p.type === 'in').sort((a, b) => a.time - b.time); 
                            const outs = group.punches.filter(p => p.type === 'out').sort((a, b) => a.time - b.time); 
                            if (ins.length > 0 && outs.length > 0) { 
                                const firstIn = ins[0].time; 
                                const lastOut = outs[outs.length - 1].time; 
                                const diffMs = lastOut - firstIn; 
                                if (diffMs < 0) return { ...group, status: 'Incomplete' }; 
                                const hours = Math.floor(diffMs / 3600000); 
                                const minutes = Math.floor((diffMs % 3600000) / 60000); 
                                return { ...group, status: 'Completed', firstIn, lastOut, workHours: `${hours}h ${minutes}m` }; 
                            } 
                            return { ...group, status: 'Incomplete' }; 
                        });
                        setMyRecords(processedRecords);
                    }
                } catch(error) {
                    // --- DEBUGGING FIX: Use alert() to show the exact error ---
                    console.error("Error fetching employee data:", error);
                    alert(`Could not load data: ${error.message}`);
                    setMessage({ type: 'error', text: `Could not load your data. Error: ${error.message}` });
                } finally {
                    setLoadingRecords(false);
                }
            };
            
            useEffect(() => {
                fetchEmployeeData();
            }, []);

            const stopScanner = async () => {
                if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) {
                    try { await html5QrCodeRef.current.stop(); } catch (err) { console.warn("Scanner stop error:", err) }
                }
                setIsScanning(false);
            };

            const handleScanSuccess = async (decodedText) => { 
                await stopScanner();
                try { 
                    const scannedData = JSON.parse(decodedText); 
                    const tokenDoc = await db.collection('system').doc('qr_token').get(); 
                    if (!tokenDoc.exists) throw new Error("QR system not configured."); 
                    const validTokenData = tokenDoc.data(); 
                    if (scannedData.token !== validTokenData.token || Date.now() > validTokenData.expiry) throw new Error("Invalid or expired QR code."); 
                    
                    const punchType = (lastPunch?.type === 'in') ? 'out' : 'in'; 
                    
                    const newRecord = { 
                        userId: auth.currentUser.uid, 
                        email: auth.currentUser.email, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        date: new Date().toISOString().split('T')[0], 
                        type: punchType 
                    }; 

                    await db.collection('attendance').add(newRecord); 

                    setMessage({ type: 'success', text: `Successfully Punched ${punchType.toUpperCase()}!` }); 
                    
                    setTimeout(() => fetchEmployeeData(), 1000);

                } catch (error) { 
                    console.error("Punch-in failed with error:", error);
                    alert(`An error occurred: ${error.message}`);
                    setMessage({ type: 'error', text: `Error: ${error.message}` }); 
                } 
            };
            
            const startScanner = () => { 
                setMessage(null); 
                setIsScanning(true);
                try {
                    const scanner = new Html5Qrcode("qr-reader"); 
                    html5QrCodeRef.current = scanner; 
                    scanner.start( { facingMode: "environment" }, { fps: 10, qrbox: {width: 250, height: 250} }, handleScanSuccess, (errorMessage) => {})
                    .catch(err => { 
                        console.error("Camera error:", err);
                        setMessage({ type: 'error', text: "Could not start camera. Please grant permission and use HTTPS." }); 
                        setIsScanning(false); 
                    });
                } catch (err) {
                    console.error("Failed to initialize Html5Qrcode:", err);
                    setMessage({ type: 'error', text: "QR Scanner failed to initialize." }); 
                    setIsScanning(false);
                }
            };
            
            return ( <div className="dashboard-layout"> <nav className="dashboard-nav"> <button className={`dashboard-nav-button ${activeView === 'scan' ? 'active' : ''}`} onClick={() => { setActiveView('scan'); stopScanner(); }}>Scan QR</button> <button className={`dashboard-nav-button ${activeView === 'history' ? 'active' : ''}`} onClick={() => { setActiveView('history'); stopScanner(); }}>My History</button> </nav> <main className="dashboard-content"> {activeView === 'scan' && ( <div> <h2>Scan Attendance QR</h2> {lastPunch && ( <div className={`status-box ${lastPunch.type === 'in' ? 'status-in' : 'status-out'}`}> Your current status: <strong>PUNCHED {lastPunch.type.toUpperCase()}</strong> 
            {lastPunch.type === 'in' && lastPunch.timestamp && ` since ${toJsDate(lastPunch.timestamp).toLocaleTimeString()}`} </div> )} {message && <p className={`message ${message.type}`}>{message.text}</p>} <div className="scan-area"> <div className="qr-reader-container">
                <div id="qr-reader" style={{ display: isScanning ? 'block' : 'none' }}></div>
                {!isScanning && <p>Camera will appear here</p>}
             </div> {!isScanning && ( <button className="scan-button" onClick={startScanner}> {lastPunch?.type === 'in' ? 'Scan to Punch OUT' : 'Scan to Punch IN'} </button> )} </div> </div> )} {activeView === 'history' && ( <div> <h2>My Attendance History</h2> {loadingRecords ? <div className="loading-spinner"></div> : ( <div className="table-responsive"> <table className="data-table"> <thead> <tr><th>Date</th><th>Punch In</th><th>Punch Out</th><th>Working Hours</th></tr> </thead> <tbody> {myRecords.length === 0 ? ( <tr><td colSpan="4">You have no attendance records yet.</td></tr> ) : ( myRecords.map(rec => ( <tr key={rec.date}> <td>{rec.date}</td> {rec.status === 'Completed' ? ( <> <td>{rec.firstIn.toLocaleTimeString()}</td> <td>{rec.lastOut.toLocaleTimeString()}</td> <td><strong>{rec.workHours}</strong></td> </> ) : ( <> <td>{rec.punches.find(p=>p.type==='in')?.time.toLocaleTimeString() || 'N/A'}</td> <td>{rec.punches.find(p=>p.type==='out')?.time.toLocaleTimeString() || 'N/A'}</td> <td className="incomplete-record">{rec.status}</td> </> )} </tr> )) )} </tbody> </table> </div> )} </div> )} </main> </div> );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showProfile, setShowProfile] = useState(false);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    setLoading(true);
                    if (currentUser) {
                        setUser(currentUser);
                        const docRef = db.collection("users").doc(currentUser.uid);
                        try {
                            const docSnap = await docRef.get();
                            if (docSnap.exists) { 
                                setUserData(docSnap.data()); 
                            } else { 
                                console.error("No user data found in Firestore for UID:", currentUser.uid);
                                setUserData(null); 
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                            setUserData(null);
                        }
                    } else { 
                        setUser(null); 
                        setUserData(null); 
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleSignOut = () => auth.signOut();
            
            if (loading) return <div className="loading-spinner"></div>;

            const renderDashboard = () => {
                if (!userData) return <div className="loading-spinner"><p>Verifying user role...</p></div>;
                switch (userData.role) {
                    case 'admin': return <AdminDashboard />;
                    case 'employee': return <EmployeeDashboard />;
                    default: return <p>Unknown role. Please contact support.</p>;
                }
            };

            return (
                <div className="App">
                    {showProfile && <ProfileModal user={userData} onClose={() => setShowProfile(false)} />}
                    <header className="app-header">
                        <h1>Office Attendance Portal</h1>
                        {user && (
                            <div className="header-actions">
                                <button className="header-button" onClick={() => setShowProfile(true)}>Profile</button>
                                <button className="header-button signout-button" onClick={handleSignOut}>Sign Out</button>
                            </div>
                        )}
                    </header>
                    <main>{!user ? <Auth /> : renderDashboard()}</main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>