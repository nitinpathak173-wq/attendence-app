<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Atmark</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #27ae60; /* Theme Green */
            --dark-blue: #1e8449; /* Darker Green for Header */
            --light-gray: #ffffff; /* Main background set to white */
            --medium-gray: #e8f5e9; /* Very Light Green for accents */
            --text-color: #333;
            --white: #ffffff;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12; /* For half day */
            --info-color: #3498db;    /* For holiday */
            --break-color: #8e44ad; /* Purple for breaks */
        }
        html, body, #root {
            height: 100%;
        }
        body { 
            font-family: 'Lato', sans-serif; 
            background-color: var(--light-gray); 
            margin: 0; 
            color: var(--text-color);
            font-size: 14px;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        .App { text-align: center; }
        .app-header { background-color: var(--dark-blue); padding: 15px 20px; color: var(--white); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .app-header h1 { margin: 0; font-size: 1.5em; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .header-button { background-color: var(--primary-color); color: var(--white); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .signout-button { background-color: var(--danger-color); }
        
        .auth-page-container {
            display: flex;
            min-height: calc(100vh - 71px); /* Full height minus header */
        }
        .auth-branding {
            flex: 1;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }
        .auth-branding .logo {
            font-size: 3.5em;
            font-weight: 700;
            margin-bottom: 20px;
        }
        .auth-branding h2 {
            font-size: 2.2em;
            font-weight: 700;
            margin: 0 0 10px 0;
        }
        .auth-branding p {
            font-size: 1.1em;
            max-width: 350px;
            line-height: 1.5;
        }
        .auth-container { 
            flex: 1;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 40px 20px;
            background-color: #f9fafb;
        }
        .auth-form { 
            background: var(--white); 
            padding: 40px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 400px; 
            border: 1px solid #eee; 
            box-sizing: border-box; 
        }
        .auth-form h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
            color: var(--text-color);
        }
        .add-employee-form { max-width: 500px; margin: 20px 0; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        .auth-button { width: 100%; padding: 15px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: background-color 0.2s; }
        .auth-button:hover { background-color: var(--dark-blue); }
        .auth-button:disabled { background-color: #1e8449; opacity: 0.8; cursor: wait; }
        
        /* --- START: Sign-in button loader styles --- */
        .auth-button .loader-container {
            --uib-size: 20px;
            --uib-color: white;
            --uib-speed: 1.75s;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            width: var(--uib-size);
            height: calc(var(--uib-size) * 0.6);
        }
        
        .auth-button .cube {
            flex-shrink: 0;
            width: calc(var(--uib-size) * 0.25);
            height: calc(var(--uib-size) * 0.25);
            animation: jump var(--uib-speed) ease-in-out infinite;
        }
        
        .auth-button .cube__inner {
            display: block;
            height: 100%;
            width: 100%;
            border-radius: 25%;
            background-color: var(--uib-color);
            transform-origin: center bottom;
            animation: morph var(--uib-speed) ease-in-out infinite;
            transition: background-color 0.3s ease;
        }
        
        .auth-button .cube:nth-child(2) {
            animation-delay: calc(var(--uib-speed) * -0.36);
        }

        .auth-button .cube:nth-child(2) .cube__inner {
            animation-delay: calc(var(--uib-speed) * -0.36);
        }

        .auth-button .cube:nth-child(3) {
            animation-delay: calc(var(--uib-speed) * -0.2);
        }

        .auth-button .cube:nth-child(3) .cube__inner {
            animation-delay: calc(var(--uib-speed) * -0.2);
        }
        
        @keyframes jump {
            0% {
                transform: translateY(0px);
            }
            30% {
                transform: translateY(0px);
                animation-timing-function: ease-out;
            }
            50% {
                transform: translateY(-200%);
                animation-timing-function: ease-in;
            }
            75% {
                transform: translateY(0px);
                animation-timing-function: ease-in;
            }
        }
        
        @keyframes morph {
            0% {
                transform: scaleY(1);
            }
            10% {
                transform: scaleY(1);
            }
            20%,
            25% {
                transform: scaleY(0.6) scaleX(1.3);
                animation-timing-function: ease-in-out;
            }
            30% {
                transform: scaleY(1.15) scaleX(0.9);
                animation-timing-function: ease-in-out;
            }
            40% {
                transform: scaleY(1);
            }
            70%,
            85%,
            100% {
                transform: scaleY(1);
            }
            75% {
                transform: scaleY(0.8) scaleX(1.2);
            }
        }
        /* --- END: Sign-in button loader styles --- */

        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .remember-me input {
            width: auto;
        }
        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }
        .forgot-password:hover {
            text-decoration: underline;
        }
        .help-link {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #666;
        }
        .help-link a {
            color: var(--primary-color);
            font-weight: bold;
            text-decoration: none;
        }
        .help-link a:hover {
            text-decoration: underline;
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        .container {
            --uib-size: 45px;
            --uib-color: var(--primary-color);
            --uib-speed: 2.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: var(--uib-size);
            width: var(--uib-size);
        }

        .slice {
            position: relative;
            height: calc(var(--uib-size) / 6);
            width: 100%;
        }

        .slice::before,
        .slice::after {
            --uib-a: calc(var(--uib-speed) / -2);
            --uib-b: calc(var(--uib-speed) / -6);
            content: '';
            position: absolute;
            top: 0;
            left: calc(50% - var(--uib-size) / 12);
            height: 100%;
            width: calc(100% / 6);
            border-radius: 50%;
            background-color: var(--uib-color);
            flex-shrink: 0;
            animation: orbit var(--uib-speed) linear infinite;
            transition: background-color 0.3s ease;
        }

        .slice:nth-child(1)::after {
            animation-delay: var(--uib-a);
        }

        .slice:nth-child(2)::before {
            animation-delay: var(--uib-b);
        }

        .slice:nth-child(2)::after {
            animation-delay: calc(var(--uib-a) + var(--uib-b));
        }

        .slice:nth-child(3)::before {
            animation-delay: calc(var(--uib-b) * 2);
        }
        .slice:nth-child(3)::after {
            animation-delay: calc(var(--uib-a) + var(--uib-b) * 2);
        }

        .slice:nth-child(4)::before {
            animation-delay: calc(var(--uib-b) * 3);
        }
        .slice:nth-child(4)::after {
            animation-delay: calc(var(--uib-a) + var(--uib-b) * 3);
        }

        .slice:nth-child(5)::before {
            animation-delay: calc(var(--uib-b) * 4);
        }
        .slice:nth-child(5)::after {
            animation-delay: calc(var(--uib-a) + var(--uib-b) * 4);
        }

        .slice:nth-child(6)::before {
            animation-delay: calc(var(--uib-b) * 5);
        }
        .slice:nth-child(6)::after {
            animation-delay: calc(var(--uib-a) + var(--uib-b) * 5);
        }

        @keyframes orbit {
            0% {
                transform: translateX(calc(var(--uib-size) * 0.25)) scale(0.73684);
                opacity: 0.65;
            }
            5% {
                transform: translateX(calc(var(--uib-size) * 0.235)) scale(0.684208);
                opacity: 0.58;
            }
            10% {
                transform: translateX(calc(var(--uib-size) * 0.182)) scale(0.631576);
                opacity: 0.51;
            }
            15% {
                transform: translateX(calc(var(--uib-size) * 0.129)) scale(0.578944);
                opacity: 0.44;
            }
            20% {
                transform: translateX(calc(var(--uib-size) * 0.076)) scale(0.526312);
                opacity: 0.37;
            }
            25% {
                transform: translateX(0%) scale(0.47368);
                opacity: 0.3;
            }
            30% {
                transform: translateX(calc(var(--uib-size) * -0.076)) scale(0.526312);
                opacity: 0.37;
            }
            35% {
                transform: translateX(calc(var(--uib-size) * -0.129)) scale(0.578944);
                opacity: 0.44;
            }
            40% {
                transform: translateX(calc(var(--uib-size) * -0.182)) scale(0.631576);
                opacity: 0.51;
            }
            45% {
                transform: translateX(calc(var(--uib-size) * -0.235)) scale(0.684208);
                opacity: 0.58;
            }
            50% {
                transform: translateX(calc(var(--uib-size) * -0.25)) scale(0.73684);
                opacity: 0.65;
            }
            55% {
                transform: translateX(calc(var(--uib-size) * -0.235)) scale(0.789472);
                opacity: 0.72;
            }
            60% {
                transform: translateX(calc(var(--uib-size) * -0.182)) scale(0.842104);
                opacity: 0.79;
            }
            65% {
                transform: translateX(calc(var(--uib-size) * -0.129)) scale(0.894736);
                opacity: 0.86;
            }
            70% {
                transform: translateX(calc(var(--uib-size) * -0.076)) scale(0.947368);
                opacity: 0.93;
            }
            75% {
                transform: translateX(0%) scale(1);
                opacity: 1;
            }
            80% {
                transform: translateX(calc(var(--uib-size) * 0.076)) scale(0.947368);
                opacity: 0.93;
            }
            85% {
                transform: translateX(calc(var(--uib-size) * 0.129)) scale(0.894736);
                opacity: 0.86;
            }
            90% {
                transform: translateX(calc(var(--uib-size) * 0.182)) scale(0.842104);
                opacity: 0.79;
            }
            95% {
                transform: translateX(calc(var(--uib-size) * 0.235)) scale(0.789472);
                opacity: 0.72;
            }
            100% {
                transform: translateX(calc(var(--uib-size) * 0.25)) scale(0.73684);
                opacity: 0.65;
            }
        }
        
        .dashboard-layout { display: flex; max-width: 1200px; margin: 20px auto; background: var(--white); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 8px; min-height: 80vh; border: 1px solid #e0e0e0; }
        .dashboard-nav { flex: 0 0 220px; background-color: var(--medium-gray); border-right: 1px solid #ddd; padding: 20px 0; border-radius: 8px 0 0 8px; }
        .dashboard-nav-button { display: block; width: 100%; padding: 15px 20px; background: none; border: none; text-align: left; font-size: 1em; color: var(--dark-blue); cursor: pointer; border-left: 4px solid transparent; font-family: 'Lato', sans-serif; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        .dashboard-nav-button.active { background-color: var(--white); border-left: 4px solid var(--primary-color); font-weight: bold; }
        .dashboard-nav-button:not(.active):hover { background-color: #dcf0de; color: var(--primary-color); }
        .dashboard-content { flex-grow: 1; padding: 30px; overflow: hidden; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        .data-table th { background-color: var(--medium-gray); }
        .incomplete-record { color: #e67e22; font-weight: bold; }

        .new-day-separator td {
            border-top: 3px solid #3498db; /* A distinct blue line */
        }
        
        .status-cell span { padding: 4px 8px; border-radius: 4px; color: var(--white); font-weight: bold; font-size: 0.9em; }
        .status-present { background-color: var(--success-color); }
        .status-absent { background-color: var(--danger-color); }
        .status-holiday { background-color: var(--info-color); }
        .status-half-day { background-color: var(--warning-color); color: var(--text-color) !important; }

        .punch-log-cell { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        .punch-log-item { padding: 3px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; white-space: nowrap; }
        .punch-log-item.punch-in { background-color: var(--success-color); color: var(--white); }
        .punch-log-item.punch-out { background-color: #fbe9e7; color: #d84315; border: 1px solid #ffccbc; }

        @media (max-width: 992px) {
            .auth-page-container { flex-direction: column; }
            .auth-branding { min-height: 250px; justify-content: flex-end; padding-bottom: 50px; }
            .auth-container { padding: 30px 15px; }
        }

        @media (max-width: 768px) {
            .dashboard-layout { flex-direction: column; margin: 10px auto; }
            .dashboard-nav { flex-direction: row; flex: 0 0 auto; border-right: none; border-bottom: 1px solid #ddd; padding: 0; border-radius: 8px 8px 0 0; display: flex; overflow-x: auto; }
            .dashboard-nav-button { text-align: center; border-left: none; border-bottom: 4px solid transparent; padding: 15px 20px; font-size: 0.9em; white-space: nowrap; }
            .dashboard-nav-button.active { border-left-color: transparent; border-bottom: 4px solid var(--primary-color); }
            .dashboard-content { padding: 20px 15px; }
            .auth-form { padding: 25px; }
            .add-employee-form { margin: 10px 0; }
        }

        .qr-timer { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
        .qr-timer span { color: var(--primary-color); }
        #qrcode-container { display: flex; justify-content: center; align-items: center; padding: 20px; border: 1px solid #ddd; border-radius: 8px; min-height: 256px; }
        .scan-area { display: flex; flex-direction: column; align-items: center; }
        .qr-reader-container { width: 100%; max-width: 400px; aspect-ratio: 1 / 1; border: 3px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: #fafafa; margin-bottom: 20px; position: relative; }
        #qr-reader { width: 100%; border-radius: 6px; }
        .qr-reader-container p { position: absolute; }
        .scan-button { background-color: var(--success-color); color: var(--white); font-size: 1.1em; padding: 15px 30px; border-radius: 8px; border: none; cursor: pointer; }
        .scan-button.break-button { background-color: var(--break-color); }
        .status-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.1em; }
        .status-in { background-color: #e8f5e9; color: #2e7d32; }
        .status-out { background-color: #fff3e0; color: #e65100; }
        .message { padding: 10px; border-radius: 4px; margin: 15px 0; border: 1px solid transparent; }
        .message.success { background-color: #e8f5e9; color: #2e7d32; }
        .message.error { background-color: #fdecea; color: #c62828; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--white); padding: 30px 40px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left;}
        .modal-content h2 { color: var(--dark-blue); margin-top: 0; }
        .profile-info p { margin: 10px 0; font-size: 1.1em; }
        .profile-info strong { color: var(--dark-blue); min-width: 110px; display: inline-block; }
        .modal-close-btn { display: block; margin: 20px auto 0; padding: 10px 30px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 5px; font-size: 1em; cursor: pointer; }

        .break-management { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .break-status { font-size: 1.2em; margin-bottom: 15px; }
        .break-status.on-break { color: var(--break-color); font-weight: bold; }
        .break-status.disabled { color: #777; }
        
        .modern-modal-content { background: var(--white); padding: 0; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; overflow: hidden; }
        .modern-modal-header { padding: 20px; font-size: 1.4em; font-weight: bold; color: var(--white); }
        .modern-modal-header.success { background-color: var(--success-color); }
        .modern-modal-header.error { background-color: var(--danger-color); }
        .modern-modal-header.confirm { background-color: var(--warning-color); color: var(--text-color); }
        .modern-modal-body { padding: 30px 25px; font-size: 1.1em; line-height: 1.6; color: #555; }
        .modern-modal-footer { padding: 20px; background-color: #f7f7f7; display: flex; justify-content: flex-end; gap: 15px; }
        .modal-btn { border: none; padding: 12px 25px; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .modal-btn:hover { opacity: 0.85; }
        .modal-btn-confirm { background-color: var(--danger-color); color: var(--white); }
        .modal-btn-cancel { background-color: #ddd; color: var(--text-color); }
        .modal-btn-ok { background-color: var(--primary-color); color: var(--white); }
    </style>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const firebaseConfig = {
          apiKey: "AIzaSyA4521rQz-6fd1Gvo52T6m1hJjuo06QguU",
          authDomain: "attendence-f7ea5.firebaseapp.com",
          projectId: "attendence-f7ea5",
          storageBucket: "attendence-f7ea5.appspot.com",
          messagingSenderId: "693491114475",
          appId: "1:693491114475:web:fdf1b333c9c9938a96b9ae"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const getLocalDateString = (date = new Date()) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const ModernModal = ({ title, message, type, onConfirm, onClose }) => {
            if (!message) return null;
            
            const handleOverlayClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div className="modal-overlay" onClick={handleOverlayClick}>
                    <div className="modern-modal-content">
                        <div className={`modern-modal-header ${type}`}>
                            {title || 'Notification'}
                        </div>
                        <div className="modern-modal-body">
                            <p>{message}</p>
                        </div>
                        <div className="modern-modal-footer">
                            {type === 'confirm' ? (
                                <>
                                    <button className="modal-btn modal-btn-cancel" onClick={onClose}>Cancel</button>
                                    <button className="modal-btn modal-btn-confirm" onClick={() => { onConfirm(); onClose(); }}>Confirm</button>
                                </>
                            ) : (
                                <button className="modal-btn modal-btn-ok" onClick={onClose}>OK</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ProfileModal = ({ user, onClose }) => {
            if (!user) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <h2>User Profile</h2>
                        <div className="profile-info">
                            <p><strong>Name:</strong> {user.name || 'Not set'}</p>
                            <p><strong>Email:</strong> {user.email}</p>
                            <p><strong>Employee ID:</strong> {user.employeeId || 'Not set'}</p>
                            <p><strong>Role:</strong> <span style={{textTransform: 'capitalize'}}>{user.role}</span></p>
                        </div>
                        <button className="modal-close-btn" onClick={onClose}>Close</button>
                    </div>
                </div>
            );
        };

        const Auth = ({ showModal }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSigningIn, setIsSigningIn] = useState(false);
            
            const getFriendlyAuthError = (errorCode) => {
                switch(errorCode) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        return 'Invalid email or password. Please check your credentials and try again.';
                    case 'auth/invalid-email':
                        return 'The email address is not valid.';
                    default:
                        return 'An unexpected error occurred. Please try again later.';
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSigningIn(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    const friendlyMessage = getFriendlyAuthError(err.code);
                    showModal({
                        title: 'Sign In Failed',
                        message: friendlyMessage,
                        type: 'error'
                    });
                } finally {
                    setIsSigningIn(false);
                }
            };

            return (
                <div className="auth-page-container">
                    <div className="auth-branding">
                        <div className="logo">Atmark</div>
                        <h2>Welcome Back</h2>
                        <p>Your central hub for attendance. Log in to manage your workday.</p>
                    </div>
                    <div className="auth-container">
                        <div className="auth-form">
                            <h2>Attendance Login</h2>
                            <form onSubmit={handleSubmit}>
                                <div className="input-group">
                                    <label>Email Address</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required />
                                </div>
                                <div className="input-group">
                                    <label>Password</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                                </div>
                                <button type="submit" className="auth-button" style={{marginTop: '25px'}} disabled={isSigningIn}>
                                    {isSigningIn ? (
                                        <span style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '15px'}}>
                                            Signing In...
                                            <div className="loader-container">
                                                <div className="cube"><div className="cube__inner"></div></div>
                                                <div className="cube"><div className="cube__inner"></div></div>
                                                <div className="cube"><div className="cube__inner"></div></div>
                                            </div>
                                        </span>
                                    ) : (
                                        'Sign In'
                                    )}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AdminDashboard = ({ showModal }) => {
            const [users, setUsers] = useState([]);
            const [attendanceRecords, setAttendanceRecords] = useState([]);
            const [loading, setLoading] = useState({ users: true, records: true });
            const qrCodeRef = useRef(null);
            const [activeView, setActiveView] = useState('dashboard');
            const [countdown, setCountdown] = useState(30);
            const [qrPayload, setQrPayload] = useState('');
            const [newEmployee, setNewEmployee] = useState({ name: '', email: '', password: '', employeeId: '' });
            const [message, setMessage] = useState(null);
            const [filterDate, setFilterDate] = useState(getLocalDateString().substring(0, 7)); // YYYY-MM format
            
            const calculateTotalBreakMs = (breakEvents) => {
                if (!breakEvents || breakEvents.length < 2) return 0;
                const breaks = breakEvents.map(b => ({...b, time: b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp) }))
                                          .sort((a, b) => a.time - b.time);
                let totalBreakMs = 0;
                let lastStartTime = null;
                for (const event of breaks) {
                    if (event.type === 'start') {
                        lastStartTime = event.time;
                    } else if (event.type === 'end' && lastStartTime) {
                        totalBreakMs += (event.time - lastStartTime);
                        lastStartTime = null;
                    }
                }
                return totalBreakMs > 0 ? totalBreakMs : 0;
            };

            const formatMilliseconds = (ms) => {
                if (ms <= 0) return null;
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                return `${hours}h ${minutes}m`;
            };

            const handleNewEmployeeChange = (e) => {
                setNewEmployee({ ...newEmployee, [e.target.name]: e.target.value });
            };

            const handleCreateEmployee = async (e) => {
                e.preventDefault();
                setMessage(null);
                const { name, email, password, employeeId } = newEmployee;

                if (!name || !email || !password || !employeeId) {
                    setMessage({ type: 'error', text: 'All fields are required.' });
                    return;
                }
                
                const idCheck = await db.collection('users').where('employeeId', '==', employeeId).get();
                if (!idCheck.empty) {
                    setMessage({ type: 'error', text: 'An employee with this ID already exists.'});
                    return;
                }

                const tempAppName = `createUser-${Date.now()}`;
                let secondaryApp;
                try {
                    secondaryApp = firebase.initializeApp(firebaseConfig, tempAppName);
                    const secondaryAuth = secondaryApp.auth();
                    
                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                    
                    await db.collection("users").doc(userCredential.user.uid).set({
                        uid: userCredential.user.uid,
                        email: email,
                        name: name,
                        role: 'employee',
                        employeeId: employeeId,
                    });

                    await secondaryAuth.signOut();
                    
                    setMessage({ type: 'success', text: `Employee ${name} created successfully!` });
                    setNewEmployee({ name: '', email: '', password: '', employeeId: '' });
                    
                } catch (error) {
                    console.error("Error creating employee:", error);
                    setMessage({ type: 'error', text: error.message });
                } finally {
                    if (secondaryApp) {
                        secondaryApp.delete();
                    }
                }
            };
            
            useEffect(() => {
                let qrInterval;
                let countdownInterval;
                if (activeView === 'dashboard') {
                    const generateNewToken = async () => {
                        setCountdown(30);
                        const token = Math.random().toString(36).substring(2, 15);
                        const expiry = Date.now() + 30000;
                        try {
                            await db.collection('system').doc('qr_token').set({ token, expiry });
                            setQrPayload(JSON.stringify({ token, expiry }));
                        } catch (error) {
                            console.error("Error generating QR token:", error);
                        }
                    };
                    
                    generateNewToken();
                    qrInterval = setInterval(generateNewToken, 30000);
                    countdownInterval = setInterval(() => {
                        setCountdown(prev => (prev > 0 ? prev - 1 : 30));
                    }, 1000);
                }
                
                return () => {
                    clearInterval(qrInterval);
                    clearInterval(countdownInterval);
                };
            }, [activeView]);

            useEffect(() => {
                if (activeView === 'dashboard' && qrPayload) {
                    const qrContainer = document.getElementById('qrcode-container');
                    if (qrContainer) {
                        qrContainer.innerHTML = '';
                        qrCodeRef.current = new QRCode(qrContainer, { text: qrPayload, width: 256, height: 256 });
                    }
                }
            }, [activeView, qrPayload]);

            useEffect(() => {
                const fetchUsers = async () => {
                    setLoading(prev => ({ ...prev, users: true }));
                    try {
                        const userSnapshot = await db.collection('users').get();
                        setUsers(userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } catch (error) {
                        console.error("Failed to fetch users:", error);
                    } finally {
                        setLoading(prev => ({ ...prev, users: false }));
                    }
                };
                fetchUsers();
            }, []);

            useEffect(() => {
                if (users.length === 0 || !filterDate) return;

                const fetchAttendanceData = async () => {
                    setLoading(prev => ({ ...prev, records: true }));
                    try {
                        const EIGHT_HOURS_MS = 8 * 60 * 60 * 1000;
                        
                        const year = parseInt(filterDate.substring(0, 4), 10);
                        const month = parseInt(filterDate.substring(5, 7), 10);
                        const startDate = new Date(year, month - 1, 1);
                        const endDate = new Date(year, month, 0, 23, 59, 59, 999);

                        const employeeUsers = users.filter(u => u.role === 'employee');
                        
                        const attendanceSnapshot = await db.collection('attendance').where('timestamp', '>=', startDate).where('timestamp', '<=', endDate).get();
                        const records = attendanceSnapshot.docs.map(doc => doc.data());

                        const overridesSnapshot = await db.collection('attendance_overrides').where('date', '>=', getLocalDateString(startDate)).where('date', '<=', getLocalDateString(endDate)).get();
                        const overrides = overridesSnapshot.docs.map(doc => doc.data());
                        
                        const breaksSnapshot = await db.collection('breaks').where('timestamp', '>=', startDate).where('timestamp', '<=', endDate).get();
                        const allBreaks = breaksSnapshot.docs.map(doc => doc.data());

                        const recordsByDateAndUser = records.reduce((acc, record) => {
                            const key = `${record.userId}|${record.date}`;
                            if (!acc[key]) acc[key] = [];
                            acc[key].push(record);
                            return acc;
                        }, {});

                        const breaksByDateAndUser = allBreaks.reduce((acc, record) => {
                            const key = `${record.userId}|${record.date}`;
                            if (!acc[key]) acc[key] = [];
                            acc[key].push({ type: record.type, timestamp: record.timestamp });
                            return acc;
                        }, {});

                        const overridesMap = overrides.reduce((acc, override) => {
                            acc[`${override.userId}|${override.date}`] = override;
                            return acc;
                        }, {});

                        const allPossibleRecords = [];
                        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                            const dateStr = getLocalDateString(d);
                            for (const employee of employeeUsers) {
                                const key = `${employee.id}|${dateStr}`;
                                const punches = recordsByDateAndUser[key];
                                const dailyBreaks = breaksByDateAndUser[key] || [];
                                const override = overridesMap[key];
                                const totalBreakMs = calculateTotalBreakMs(dailyBreaks);

                                let recordEntry = {
                                    userId: employee.id,
                                    name: employee.name,
                                    employeeId: employee.employeeId,
                                    email: employee.email,
                                    date: dateStr,
                                    status: 'Absent',
                                    breakDuration: formatMilliseconds(totalBreakMs)
                                };

                                if (punches) {
                                    const ins = punches.filter(p => p.type === 'in').map(p => new Date(p.timestamp.seconds * 1000)).sort((a, b) => a - b);
                                    const outs = punches.filter(p => p.type === 'out').map(p => new Date(p.timestamp.seconds * 1000)).sort((a, b) => a - b);
                                    
                                    recordEntry.firstIn = ins.length > 0 ? ins[0] : null;
                                    recordEntry.lastOut = outs.length > 0 ? outs[outs.length - 1] : null;

                                    if (recordEntry.firstIn && recordEntry.lastOut) {
                                        const grossMs = recordEntry.lastOut - recordEntry.firstIn;
                                        const netWorkMs = grossMs - totalBreakMs;

                                        if (netWorkMs > 0) {
                                            recordEntry.workHours = formatMilliseconds(netWorkMs);
                                            recordEntry.status = netWorkMs >= EIGHT_HOURS_MS ? 'Present' : 'Half Day';
                                        } else {
                                            recordEntry.status = 'Incomplete';
                                        }
                                    } else if (recordEntry.firstIn || recordEntry.lastOut) {
                                        recordEntry.status = 'Incomplete';
                                    }
                                }
                                
                                if (override) {
                                    recordEntry.status = override.status;
                                }

                                allPossibleRecords.push(recordEntry);
                            }
                        }
                        
                        allPossibleRecords.sort((a, b) => b.date.localeCompare(a.date) || a.email.localeCompare(b.email));
                        setAttendanceRecords(allPossibleRecords);
                    } catch (error) { 
                        console.error("Failed to fetch attendance data:", error); 
                    } finally { 
                        setLoading(prev => ({ ...prev, records: false })); 
                    }
                };
                
                fetchAttendanceData();
            }, [filterDate, users]);


            const handleStatusChange = async (userId, date, newStatus) => {
                const todayStr = getLocalDateString();
                if (date > todayStr) {
                    showModal({
                        title: 'Invalid Action',
                        message: 'Attendance cannot be marked for future dates.',
                        type: 'error'
                    });
                    return;
                }

                const overrideId = `${userId}_${date}`;
                const overrideRef = db.collection('attendance_overrides').doc(overrideId);
                
                try {
                    await overrideRef.set({
                        userId,
                        date,
                        status: newStatus,
                        updatedBy: auth.currentUser.uid,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setAttendanceRecords(prevRecords => 
                        prevRecords.map(rec => 
                            (rec.userId === userId && rec.date === date) ? { ...rec, status: newStatus } : rec
                        )
                    );
                } catch (error) {
                    console.error("Failed to update status:", error);
                    showModal({
                        title: 'Update Failed',
                        message: 'Could not update the status. Please try again.',
                        type: 'error'
                    });
                }
            };

            const handleRoleChange = async (userId, newRole) => { await db.collection('users').doc(userId).update({ role: newRole }); setUsers(users.map(u => u.id === userId ? { ...u, role: newRole } : u)); };
            
            const handleDeleteEmployee = (userId, userName) => {
                showModal({
                    title: 'Confirm Deletion',
                    message: `Are you sure you want to delete the user record for "${userName}"? This cannot be undone.`,
                    type: 'confirm',
                    onConfirm: async () => {
                        try {
                            await db.collection('users').doc(userId).delete();
                            setUsers(prevUsers => prevUsers.filter(user => user.id !== userId));
                            showModal({
                                title: 'Success',
                                message: `User record for ${userName} has been deleted.`,
                                type: 'success'
                            });
                        } catch (error) {
                            console.error("Error deleting user record: ", error);
                            showModal({
                                title: 'Deletion Failed',
                                message: 'Failed to delete user record. Please see the console for more details.',
                                type: 'error'
                            });
                        }
                    }
                });
            };
            
            const handleDownload = () => {
                const headers = ["Employee Name", "Employee ID", "Employee Email", "Date", "Punch In", "Punch Out", "Working Hours", "Break Duration", "Status"];
                const csvRows = [headers.join(',')];
                for (const rec of attendanceRecords) {
                    const punchIn = rec.firstIn ? rec.firstIn.toLocaleTimeString() : 'N/A';
                    const punchOut = rec.lastOut ? rec.lastOut.toLocaleTimeString() : 'N/A';
                    const workHours = rec.workHours || 'N/A';
                    const breakDuration = rec.breakDuration || 'N/A';
                    const row = [rec.name, (rec.employeeId || 'N/A'), rec.email, rec.date, punchIn, punchOut, `"${workHours}"`, `"${breakDuration}"`, rec.status];
                    csvRows.push(row.join(','));
                }
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `attendance_records_${filterDate}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const renderStatusCell = (rec) => {
                const todayStr = getLocalDateString();
                const isFutureDate = rec.date > todayStr;

                switch (rec.status) {
                    case 'Present':
                        return <strong>{rec.workHours}</strong>;
                    case 'Incomplete':
                        return <span className="incomplete-record">{rec.status}</span>;
                    default:
                        return (
                            <select 
                                value={rec.status} 
                                onChange={(e) => handleStatusChange(rec.userId, rec.date, e.target.value)}
                                disabled={isFutureDate}
                            >
                                <option value="Absent">Absent</option>
                                <option value="Present">Present</option>
                                <option value="Half Day">Half Day</option>
                                <option value="Holiday">Holiday</option>
                            </select>
                        );
                }
            };

            return (
                <div className="dashboard-layout">
                    <nav className="dashboard-nav">
                        <button className={`dashboard-nav-button ${activeView === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveView('dashboard')}>Dashboard</button>
                        <button className={`dashboard-nav-button ${activeView === 'attendance' ? 'active' : ''}`} onClick={() => setActiveView('attendance')}>Attendance</button>
                        <button className={`dashboard-nav-button ${activeView === 'users' ? 'active' : ''}`} onClick={() => setActiveView('users')}>Users</button>
                        <button className={`dashboard-nav-button ${activeView === 'addEmployee' ? 'active' : ''}`} onClick={() => setActiveView('addEmployee')}>Add Employee</button>
                    </nav>
                    <main className="dashboard-content">
                        {activeView === 'dashboard' && (
                            <div>
                                <h2>Live QR Code</h2>
                                <div className="qr-timer">New code in: <span>{countdown}s</span></div>
                                <div id="qrcode-container">
                                    {!qrPayload && <div className="loading-container" style={{height: '100%'}}>
                                        <div className="container">
                                            <div className="slice"></div><div className="slice"></div><div className="slice"></div>
                                            <div className="slice"></div><div className="slice"></div><div className="slice"></div>
                                        </div>
                                    </div>}
                                </div>
                            </div>
                        )}
                        {activeView === 'attendance' && (
                            <div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                    <h2>Attendance Records</h2>
                                    <div style={{ display: 'flex', alignItems: 'center' }}>
                                        <label htmlFor="month-filter" style={{ marginRight: '10px', fontWeight: 'bold' }}>Filter by Month:</label>
                                        <input
                                            id="month-filter"
                                            type="month"
                                            value={filterDate}
                                            onChange={(e) => setFilterDate(e.target.value)}
                                            style={{ marginRight: '20px', padding: '8px', borderRadius: '5px', border: '1px solid #ddd' }}
                                        />
                                        {!loading.records && attendanceRecords.length > 0 && (<button onClick={handleDownload} className="header-button">Download CSV</button>)}
                                    </div>
                                </div>
                                {loading.records ? <div className="loading-container" style={{height: '200px'}}><div className="container"><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div></div></div> : ( attendanceRecords.length > 0 ? ( <div className="table-responsive"><table className="data-table">
                                <thead><tr><th>Employee Name</th><th>Employee ID</th><th>Email</th><th>Date</th><th>Punch In</th><th>Punch Out</th><th>Break Duration</th><th>Net Hours</th></tr></thead>
                                <tbody>
                                    {(() => {
                                        let lastDate = null;
                                        return attendanceRecords.map(rec => {
                                            const isNewDay = rec.date !== lastDate;
                                            lastDate = rec.date;
                                            const rowClass = isNewDay ? 'new-day-separator' : '';

                                            return (
                                                <tr key={`${rec.userId}-${rec.date}`} className={rowClass}>
                                                    <td>{rec.name}</td>
                                                    <td>{rec.employeeId || 'N/A'}</td>
                                                    <td>{rec.email}</td>
                                                    <td>{rec.date}</td>
                                                    <td>{rec.firstIn ? rec.firstIn.toLocaleTimeString() : 'N/A'}</td>
                                                    <td>{rec.lastOut ? rec.lastOut.toLocaleTimeString() : 'N/A'}</td>
                                                    <td>{rec.breakDuration || 'N/A'}</td>
                                                    <td>{renderStatusCell(rec)}</td>
                                                </tr>
                                            );
                                        });
                                    })()}
                                </tbody></table></div>) : (<p>No attendance records found for the selected month.</p>) )}
                            </div>
                        )}
                        {activeView === 'users' && (
                            <div>
                                <h2>User Management</h2>
                                {loading.users ? <div className="loading-container" style={{height: '200px'}}><div className="container"><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div></div></div> : ( users.length > 0 ? ( <div className="table-responsive"><table className="data-table"><thead><tr><th>Name</th><th>Email</th><th>Employee ID</th><th>Role</th><th>Change Role</th><th>Actions</th></tr></thead><tbody>{users.map(user => (<tr key={user.id}><td>{user.name}</td><td>{user.email}</td><td>{user.employeeId || 'N/A'}</td><td style={{textTransform: 'capitalize'}}>{user.role}</td><td><select value={user.role} onChange={(e) => handleRoleChange(user.id, e.target.value)} disabled={user.role === 'admin'}><option value="admin">Admin</option><option value="employee">Employee</option></select></td><td>{user.role !== 'admin' && (<button onClick={() => handleDeleteEmployee(user.id, user.name)} className="header-button signout-button" style={{padding: '5px 10px', fontSize: '0.8em'}}>Delete</button>)}</td></tr>))}</tbody></table></div>) : (<p>No users found.</p>) )}
                            </div>
                        )}
                        {activeView === 'addEmployee' && (
                            <div>
                                <h2>Add New Employee</h2>
                                <form onSubmit={handleCreateEmployee} className="auth-form add-employee-form">
                                    {message && <p className={`message ${message.type}`}>{message.text}</p>}
                                    <div className="input-group">
                                        <label>Full Name</label>
                                        <input type="text" name="name" value={newEmployee.name} onChange={handleNewEmployeeChange} required />
                                    </div>
                                    <div className="input-group">
                                        <label>Email Address</label>
                                        <input type="email" name="email" value={newEmployee.email} onChange={handleNewEmployeeChange} required />
                                    </div>
                                    <div className="input-group">
                                        <label>Employee ID</label>
                                        <input type="text" name="employeeId" value={newEmployee.employeeId} onChange={handleNewEmployeeChange} required />
                                    </div>
                                    <div className="input-group">
                                        <label>Password</label>
                                        <input type="password" name="password" value={newEmployee.password} onChange={handleNewEmployeeChange} required />
                                    </div>
                                    <button type="submit" className="auth-button">Create Employee</button>
                                </form>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const EmployeeDashboard = () => {
            const [activeView, setActiveView] = useState('scan');
            const [lastPunch, setLastPunch] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [message, setMessage] = useState(null);
            const html5QrCodeRef = useRef(null);
            const [myRecords, setMyRecords] = useState([]);
            const [loadingRecords, setLoadingRecords] = useState(true);
            const [hasPunchedInToday, setHasPunchedInToday] = useState(false);
            const [hasPunchedOutToday, setHasPunchedOutToday] = useState(false);
            const [lastBreak, setLastBreak] = useState(null);
            const scanModeRef = useRef('punch');

            const toJsDate = (timestamp) => {
                if (!timestamp) return null;
                if (typeof timestamp.seconds === 'number' && typeof timestamp.nanoseconds === 'number') { return timestamp.toDate(); }
                return timestamp;
            };

            const calculateTotalBreakMs = (breakEvents) => {
                if (!breakEvents || breakEvents.length < 2) return 0;
                const breaks = breakEvents.map(b => ({...b, time: toJsDate(b.timestamp) }))
                                          .sort((a, b) => a.time - b.time);
                let totalBreakMs = 0;
                let lastStartTime = null;
                for (const event of breaks) {
                    if (event.type === 'start') {
                        lastStartTime = event.time;
                    } else if (event.type === 'end' && lastStartTime) {
                        totalBreakMs += (event.time - lastStartTime);
                        lastStartTime = null;
                    }
                }
                return totalBreakMs > 0 ? totalBreakMs : 0;
            };

            const formatMilliseconds = (ms) => {
                if (ms <= 0) return null;
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                return `${hours}h ${minutes}m`;
            };

            const fetchEmployeeData = async () => {
                if (!auth.currentUser) return;
                setLoadingRecords(true);
                try {
                    const EIGHT_HOURS_MS = 8 * 60 * 60 * 1000;
                    const todayStr = getLocalDateString();

                    const attendanceRef = db.collection('attendance').where('userId', '==', auth.currentUser.uid).orderBy('timestamp', 'desc');
                    const snapshot = await attendanceRef.get();
                    const allRecords = snapshot.docs.map(doc => doc.data());

                    const breakRef = db.collection('breaks').where('userId', '==', auth.currentUser.uid).orderBy('timestamp', 'asc');
                    const breakSnapshot = await breakRef.get();
                    const allBreaks = breakSnapshot.docs.map(doc => doc.data());
                    
                    const todaysRecords = allRecords.filter(rec => rec.date === todayStr);
                    setHasPunchedInToday(todaysRecords.some(rec => rec.type === 'in'));
                    setHasPunchedOutToday(todaysRecords.some(rec => rec.type === 'out'));
                    setLastPunch(todaysRecords[0] || null);
                    
                    const todaysBreakRef = db.collection('breaks').where('userId', '==', auth.currentUser.uid).where('date', '==', todayStr).orderBy('timestamp', 'desc').limit(1);
                    const todaysBreakSnapshot = await todaysBreakRef.get();
                    setLastBreak(todaysBreakSnapshot.empty ? null : todaysBreakSnapshot.docs[0].data());
                    
                    const overridesRef = db.collection('attendance_overrides').where('userId', '==', auth.currentUser.uid);
                    const overridesSnapshot = await overridesRef.get();
                    const overrides = overridesSnapshot.docs.map(doc => doc.data());
                    const overridesMap = overrides.reduce((acc, o) => ({...acc, [o.date]: o }), {});
                    
                    const groupedRecords = allRecords.reduce((acc, record) => {
                        const date = record.date;
                        if (!acc[date]) { acc[date] = { date, punches: [] }; }
                        acc[date].punches.push({ type: record.type, time: toJsDate(record.timestamp) });
                        return acc;
                    }, {});

                    const breaksByDate = allBreaks.reduce((acc, br) => {
                        const date = br.date;
                        if (!acc[date]) { acc[date] = []; }
                        acc[date].push({ type: br.type, timestamp: br.timestamp });
                        return acc;
                    }, {});

                    const allPossibleRecords = [];
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - 29); 

                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateStr = getLocalDateString(d);
                        
                        const group = groupedRecords[dateStr];
                        const dailyBreaks = breaksByDate[dateStr] || [];
                        const override = overridesMap[dateStr];

                        let recordEntry = {
                            date: dateStr,
                            punches: group ? group.punches.sort((a, b) => a.time - b.time) : [],
                            status: 'Absent',
                            workHours: null,
                            breakDuration: null
                        };

                        const totalBreakMs = calculateTotalBreakMs(dailyBreaks);
                        recordEntry.breakDuration = formatMilliseconds(totalBreakMs);

                        if (override) {
                            recordEntry.status = override.status;
                        } else if (group) {
                            const ins = recordEntry.punches.filter(p => p.type === 'in');
                            const outs = recordEntry.punches.filter(p => p.type === 'out');
                            
                            const firstIn = ins.length > 0 ? ins[0].time : null;
                            const lastOut = outs.length > 0 ? outs[outs.length - 1].time : null;

                            if (firstIn && lastOut) {
                                const grossMs = lastOut - firstIn;
                                const netWorkMs = grossMs - totalBreakMs;

                                if (netWorkMs < 0) {
                                    recordEntry.status = 'Incomplete';
                                } else {
                                    recordEntry.workHours = formatMilliseconds(netWorkMs);
                                    recordEntry.status = netWorkMs >= EIGHT_HOURS_MS ? 'Present' : 'Half Day';
                                }
                            } else if (firstIn || lastOut) {
                                recordEntry.status = 'Incomplete';
                            }
                        }
                        
                        allPossibleRecords.push(recordEntry);
                    }

                    allPossibleRecords.sort((a, b) => b.date.localeCompare(a.date));
                    setMyRecords(allPossibleRecords);
                } catch(error) {
                    console.error("Error fetching employee data:", error);
                    setMessage({ type: 'error', text: `Could not load your data. Error: ${error.message}` });
                } finally { setLoadingRecords(false); }
            };
            
            useEffect(() => { fetchEmployeeData(); }, []);

            const stopScanner = async () => {
                if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) {
                    try { await html5QrCodeRef.current.stop(); } catch (err) { console.warn("Scanner stop error:", err) }
                }
                setIsScanning(false);
            };

            const handleScanSuccess = async (decodedText) => { 
                await stopScanner();
                try { 
                    const scannedData = JSON.parse(decodedText); 
                    const tokenDoc = await db.collection('system').doc('qr_token').get(); 
                    if (!tokenDoc.exists) throw new Error("QR system not configured."); 
                    const validTokenData = tokenDoc.data(); 
                    if (scannedData.token !== validTokenData.token || Date.now() > validTokenData.expiry) throw new Error("Invalid or expired QR code."); 
                    
                    if (scanModeRef.current === 'punch') {
                        const punchType = (lastPunch?.type === 'in') ? 'out' : 'in'; 
                        if (punchType === 'in' && hasPunchedInToday) { throw new Error("You have already punched IN today."); }
                        if (punchType === 'out' && !hasPunchedInToday) { throw new Error("You must punch IN before you can punch OUT."); }
                        if (punchType === 'out' && hasPunchedOutToday) { throw new Error("You have already punched OUT today."); }
                        
                        const newRecord = { userId: auth.currentUser.uid, email: auth.currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp(), date: getLocalDateString(), type: punchType }; 
                        await db.collection('attendance').add(newRecord); 
                        setMessage({ type: 'success', text: `Successfully Punched ${punchType.toUpperCase()}!` });

                        // --- START: NEW NOTIFICATION LOGIC ---
                        if (punchType === 'in') {
                            const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
                            const userName = userDoc.exists ? userDoc.data().name : auth.currentUser.email;
                            const adminSnapshot = await db.collection("users").where("role", "==", "admin").get();
                            if (!adminSnapshot.empty) {
                                adminSnapshot.forEach(adminDoc => {
                                    const adminId = adminDoc.id;
                                    db.collection("notifications").add({
                                        recipientId: adminId,
                                        message: `${userName} has punched IN.`,
                                        read: false,
                                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                        link: "/attendance"
                                    });
                                });
                                console.log("Created notifications for admins.");
                            }
                        }
                        // --- END: NEW NOTIFICATION LOGIC ---

                    } else if (scanModeRef.current === 'break') {
                        const isOnBreak = lastBreak?.type === 'start';
                        const breakType = isOnBreak ? 'end' : 'start';
                        const newBreakRecord = { userId: auth.currentUser.uid, email: auth.currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp(), date: getLocalDateString(), type: breakType };
                        await db.collection('breaks').add(newBreakRecord);
                        setMessage({ type: 'success', text: `Break ${breakType === 'start' ? 'started' : 'ended'} successfully!` });
                    }
                    
                    setTimeout(() => fetchEmployeeData(), 1000);
                } catch (error) { 
                    console.error("Scan failed with error:", error);
                    setMessage({ type: 'error', text: `Error: ${error.message}` }); 
                } 
            };
            
            const startScanner = (mode = 'punch') => { 
                scanModeRef.current = mode;
                setMessage(null); 
                setIsScanning(true);
                try {
                    const scanner = new Html5Qrcode("qr-reader"); 
                    html5QrCodeRef.current = scanner; 
                    scanner.start( { facingMode: "environment" }, { fps: 10, qrbox: {width: 250, height: 250} }, handleScanSuccess, (errorMessage) => {})
                    .catch(err => { 
                        setMessage({ type: 'error', text: "Could not start camera. Please grant permission and use HTTPS." }); 
                        setIsScanning(false); 
                    });
                } catch (err) {
                    setMessage({ type: 'error', text: "QR Scanner failed to initialize." }); 
                    setIsScanning(false);
                }
            };
            
            const renderEmployeeStatus = (rec) => {
                switch (rec.status) {
                    case 'Present':
                        return <span className="status-cell"><span className="status-present">{rec.status}</span></span>;
                    case 'Half Day':
                        return <span className="status-cell"><span className="status-half-day">{rec.status}</span></span>;
                    case 'Incomplete':
                        return <span className="incomplete-record">{rec.status}</span>;
                    case 'Holiday':
                        return <span className="status-cell"><span className="status-holiday">{rec.status}</span></span>;
                    case 'Absent':
                        return <span className="status-cell"><span className="status-absent">{rec.status}</span></span>;
                    default:
                        return rec.status;
                }
            };
            
            const canTakeBreak = lastPunch?.type === 'in';
            const isOnBreak = lastBreak?.type === 'start';

            return (
                <div className="dashboard-layout">
                    <nav className="dashboard-nav">
                        <button className={`dashboard-nav-button ${activeView === 'scan' ? 'active' : ''}`} onClick={() => { setActiveView('scan'); stopScanner(); }}>Scan QR</button>
                        <button className={`dashboard-nav-button ${activeView === 'break' ? 'active' : ''}`} onClick={() => { setActiveView('break'); stopScanner(); }}>Manage Break</button>
                        <button className={`dashboard-nav-button ${activeView === 'history' ? 'active' : ''}`} onClick={() => { setActiveView('history'); stopScanner(); }}>My History</button>
                    </nav>
                    <main className="dashboard-content">
                        {activeView === 'scan' && (
                            <div>
                                <h2>Scan Attendance QR</h2>
                                {!lastPunch ? (
                                    <div className="status-box" style={{backgroundColor: '#e3f2fd', color: '#1e88e5'}}>
                                        Your status: <strong>Ready to Punch In</strong>
                                    </div>
                                ) : (
                                    <div className={`status-box ${lastPunch.type === 'in' ? 'status-in' : 'status-out'}`}>
                                        Your current status: <strong>PUNCHED {lastPunch.type.toUpperCase()}</strong>
                                        {lastPunch.type === 'in' && lastPunch.timestamp && ` since ${toJsDate(lastPunch.timestamp).toLocaleTimeString()}`}
                                    </div>
                                )}
                                {message && <p className={`message ${message.type}`}>{message.text}</p>}
                                <div className="scan-area">
                                    <div className="qr-reader-container">
                                        <div id="qr-reader" style={{ display: isScanning ? 'block' : 'none' }}></div>
                                        {!isScanning && <p>Camera will appear here</p>}
                                    </div>
                                    {!isScanning && (
                                        <>
                                            {hasPunchedInToday && hasPunchedOutToday ? (
                                                <p style={{marginTop: '20px', fontWeight: 'bold'}}>You have completed your attendance for today.</p>
                                            ) : (
                                                <button className="scan-button" onClick={() => startScanner('punch')}>
                                                    {lastPunch?.type === 'in' ? 'Scan to Punch OUT' : 'Scan to Punch IN'}
                                                </button>
                                            )}
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                        {activeView === 'break' && (
                            <div>
                                <h2>Break Management</h2>
                                {message && <p className={`message ${message.type}`}>{message.text}</p>}
                                <div className="scan-area">
                                    <div className="qr-reader-container">
                                        <div id="qr-reader" style={{ display: isScanning ? 'block' : 'none' }}></div>
                                        {!isScanning && <p>Camera will appear here</p>}
                                    </div>
                                    {!isScanning && (
                                      <div>
                                        {!canTakeBreak ? (
                                            <p className="break-status disabled">You must be punched in to take a break.</p>
                                        ) : isOnBreak ? (
                                            <>
                                                <p className="break-status on-break">You are currently ON BREAK.</p>
                                                <button className="scan-button break-button" onClick={() => startScanner('break')}>
                                                    Scan to End Break
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                <p className="break-status">You are not on a break.</p>
                                                <button className="scan-button break-button" onClick={() => startScanner('break')}>
                                                    Scan to Start Break
                                                </button>
                                            </>
                                        )}
                                      </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {activeView === 'history' && (
                            <div>
                                <h2>My Attendance History</h2>
                                {loadingRecords ? <div className="loading-container" style={{height: '200px'}}><div className="container"><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div><div className="slice"></div></div></div> : (
                                    <div className="table-responsive">
                                        <table className="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Punch Log</th>
                                                    <th>Net Hours</th>
                                                    <th>Break Duration</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {myRecords.length === 0 ? (
                                                    <tr><td colSpan="5">You have no attendance records yet.</td></tr>
                                                ) : (
                                                    myRecords.map(rec => (
                                                        <tr key={rec.date}>
                                                            <td>{rec.date}</td>
                                                            <td>
                                                                <div className="punch-log-cell">
                                                                {rec.punches && rec.punches.length > 0 ? (
                                                                    rec.punches.map((punch, index) => (
                                                                        <span key={index} className={`punch-log-item punch-${punch.type}`}>
                                                                            {`${punch.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${punch.type.toUpperCase()})`}
                                                                        </span>
                                                                    ))
                                                                ) : (
                                                                    <span>No Punches</span>
                                                                )}
                                                                </div>
                                                            </td>
                                                            <td><strong>{rec.workHours || 'N/A'}</strong></td>
                                                            <td><strong>{rec.breakDuration || 'N/A'}</strong></td>
                                                            <td>{renderEmployeeStatus(rec)}</td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showProfile, setShowProfile] = useState(false);
            const [modalConfig, setModalConfig] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [showNotifications, setShowNotifications] = useState(false);

            useEffect(() => {
                let unsubscribeUserData = () => {};
                const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => {
                    setLoading(true);
                    unsubscribeUserData(); 
                    if (currentUser) {
                        setUser(currentUser);
                        const docRef = db.collection("users").doc(currentUser.uid);
                        unsubscribeUserData = docRef.onSnapshot((docSnap) => {
                            if (docSnap.exists) {
                                setUserData(docSnap.data());
                                setLoading(false);
                            } else {
                                setUserData(null);
                                setLoading(false);
                                auth.signOut(); 
                                showModal({
                                    title: 'Access Denied',
                                    message: 'You are no longer a member of this company. Please contact administration.',
                                    type: 'error'
                                });
                            }
                        }, (error) => {
                            console.error("Error listening to user data:", error);
                            setUserData(null);
                            setLoading(false);
                            auth.signOut();
                        });
                    } else { 
                        setUser(null); 
                        setUserData(null); 
                        setLoading(false);
                    }
                });
                return () => { unsubscribeAuth(); unsubscribeUserData(); };
            }, []);
            
            useEffect(() => {
                if (!user || !userData) {
                    setNotifications([]);
                    return;
                }
                const unsubscribe = db.collection("notifications")
                    .where("recipientId", "==", user.uid)
                    .orderBy("timestamp", "desc")
                    .limit(10)
                    .onSnapshot(snapshot => {
                        const userNotifications = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setNotifications(userNotifications);
                    });
                return () => unsubscribe();
            }, [user, userData]);

            const showModal = (config) => setModalConfig(config);
            const hideModal = () => setModalConfig(null);
            const handleSignOut = () => auth.signOut();
            const unreadCount = notifications.filter(n => !n.read).length;
            const markAsRead = (notificationId) => {
                db.collection("notifications").doc(notificationId).update({ read: true });
            };

            if (loading) {
                return (
                    <div className="loading-container">
                        <div className="container">
                            <div className="slice"></div><div className="slice"></div><div className="slice"></div>
                            <div className="slice"></div><div className="slice"></div><div className="slice"></div>
                        </div>
                    </div>
                );
            }

            const renderDashboard = () => {
                if (!userData) {
                    return (
                        <div className="loading-container">
                            <div className="container" style={{ marginBottom: '20px' }}>
                                <div className="slice"></div><div className="slice"></div><div className="slice"></div>
                                <div className="slice"></div><div className="slice"></div><div className="slice"></div>
                            </div>
                            <p>Verifying user role...</p>
                        </div>
                    );
                }
                switch (userData.role) {
                    case 'admin': return <AdminDashboard showModal={showModal} />;
                    case 'employee': return <EmployeeDashboard />;
                    default: return <p>Unknown role. Please contact support.</p>;
                }
            };

            return (
                <div className="App" style={{height: !user ? '100%' : 'auto'}}>
                    {modalConfig && <ModernModal {...modalConfig} onClose={hideModal} />}
                    {showProfile && <ProfileModal user={userData} onClose={() => setShowProfile(false)} />}
                    {user && (
                        <header className="app-header">
                            <h1>Atmark</h1>
                            <div className="header-actions">
                                <div 
                                    className="notification-bell" 
                                    onClick={() => setShowNotifications(!showNotifications)}
                                    style={{position: 'relative', color: 'white', marginRight: '15px', cursor: 'pointer'}}
                                >
                                    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21 19v1H3v-1l2-2v-6c0-3.1 2.03-5.83 5-6.71V4a2 2 0 0 1 2-2a2 2 0 0 1 2 2v.29c2.97.88 5 3.61 5 6.71v6l2 2m-7 2a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"/></svg>
                                    {unreadCount > 0 && 
                                        <span style={{ position: 'absolute', top: '-5px', right: '-8px', background: '#e74c3c', borderRadius: '50%', color: 'white', fontSize: '10px', padding: '2px 5px', border: '1px solid white' }}>
                                            {unreadCount}
                                        </span>
                                    }
                                </div>
                                <button className="header-button" onClick={() => setShowProfile(true)}>Profile</button>
                                <button className="header-button signout-button" onClick={handleSignOut}>Sign Out</button>
                            </div>
                        </header>
                    )}
                    {showNotifications && (
                        <div className="notifications-dropdown" style={{position: 'absolute', top: '70px', right: '20px', width: '350px', background: 'white', border: '1px solid #ddd', borderRadius: '8px', boxShadow: '0 4px 10px rgba(0,0,0,0.1)', zIndex: 1100, textAlign: 'left'}}>
                            <div style={{padding: '15px', borderBottom: '1px solid #eee', fontWeight: 'bold'}}>Notifications</div>
                            {notifications.length === 0 ? (
                                 <p style={{padding: '20px', color: '#777'}}>No new notifications.</p>
                            ) : (
                                notifications.map(note => (
                                    <div 
                                        key={note.id} 
                                        onClick={() => markAsRead(note.id)}
                                        style={{padding: '15px', borderBottom: '1px solid #eee', cursor: 'pointer', background: note.read ? 'white' : '#e8f5e9'}}
                                    >
                                        <p style={{margin: 0, fontSize: '14px'}}>{note.message}</p>
                                        <small style={{color: '#777'}}>{note.timestamp?.toDate().toLocaleString()}</small>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                    <main style={{height: !user ? 'calc(100% - 71px)' : 'auto'}}>
                        {!user ? <Auth showModal={showModal} /> : renderDashboard()}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>